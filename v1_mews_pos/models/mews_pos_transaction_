# -*- coding: utf-8 -*-

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import json
import uuid
from datetime import datetime


class MewsPosTransaction(models. Model):
    """POS işlem kayıtları"""
    _name = 'mews.pos.transaction'
    _description = 'Mews POS İşlem Kaydı'
    _order = 'create_date desc'
    _rec_name = 'transaction_id'

    transaction_id = fields.Char(
        string='İşlem ID',
        required=True,
        readonly=True,
        default=lambda self: str(uuid. uuid4())
    )
    
    order_id = fields. Many2one(
        'sale.order',
        string='Sipariş',
        ondelete='set null'
    )
    
    bank_id = fields. Many2one(
        'mews. pos.bank',
        string='Banka',
        required=True,
        ondelete='restrict'
    )
    
    # Tutar Bilgileri
    amount = fields.Float(string='Tutar', digits=(12, 2), required=True)
    currency = fields.Selection([
        ('TRY', 'Türk Lirası'),
        ('USD', 'Amerikan Doları'),
        ('EUR', 'Euro'),
        ('GBP', 'İngiliz Sterlini'),
    ], string='Para Birimi', default='TRY', required=True)
    
    installment_count = fields.Integer(string='Taksit Sayısı', default=1)
    installment_amount = fields.Float(string='Taksit Tutarı', digits=(12, 2))
    total_amount = fields. Float(string='Toplam Tutar', digits=(12, 2))
    
    # Kart Bilgileri (Maskeli)
    card_number_masked = fields.Char(string='Kart No (Maskeli)')
    card_holder_name = fields. Char(string='Kart Sahibi')
    card_type = fields.Selection([
        ('visa', 'Visa'),
        ('mastercard', 'Mastercard'),
        ('amex', 'American Express'),
        ('troy', 'Troy'),
    ], string='Kart Tipi')
    
    # İşlem Durumu
    state = fields.Selection([
        ('draft', 'Taslak'),
        ('pending', 'Beklemede'),
        ('processing', 'İşleniyor'),
        ('success', 'Başarılı'),
        ('failed', 'Başarısız'),
        ('cancelled', 'İptal Edildi'),
        ('refunded', 'İade Edildi'),
    ], string='Durum', default='draft', required=True)
    
    # Banka Yanıtları
    bank_response_code = fields. Char(string='Banka Yanıt Kodu')
    bank_response_message = fields.Text(string='Banka Yanıt Mesajı')
    bank_order_id = fields. Char(string='Banka Sipariş No')
    auth_code = fields. Char(string='Onay Kodu')
    rrn = fields. Char(string='RRN')
    
    # 3D Secure
    is_3d_secure = fields. Boolean(string='3D Secure', default=False)
    threed_status = fields.Char(string='3D Durum')
    eci = fields.Char(string='ECI')
    cavv = fields. Char(string='CAVV')
    
    # Teknik Bilgiler
    ip_address = fields. Char(string='IP Adresi')
    user_agent = fields. Char(string='User Agent')
    request_data = fields.Text(string='İstek Verisi')
    response_data = fields. Text(string='Yanıt Verisi')
    error_message = fields. Text(string='Hata Mesajı')
    
    # Tarihler
    processed_at = fields. Datetime(string='İşlem Tarihi')
    
    def action_process_payment(self):
        """Ödeme işlemini başlat"""
        self.ensure_one()
        self.write({'state': 'processing'})
        # PHP servisine istek gönder
        return self._send_to_php_gateway()
    
    def action_cancel(self):
        """İşlemi iptal et"""
        self.ensure_one()
        if self.state not in ['success']: 
            raise UserError(_('Sadece başarılı işlemler iptal edilebilir! '))
        # İptal işlemi
        return self._process_cancel()
    
    def action_refund(self):
        """İade işlemi"""
        self.ensure_one()
        if self.state not in ['success']: 
            raise UserError(_('Sadece başarılı işlemler iade edilebilir!'))
        # İade işlemi
        return self._process_refund()
    
    def _send_to_php_gateway(self):
        """PHP Gateway'e istek gönder"""
        # Bu metod PHP servisiyle iletişim kurar
        config = self.bank_id.get_account_config()
        
        payload = {
            'transaction_id': self.transaction_id,
            'amount':  self.total_amount,
            'currency': self. currency,
            'installment':  self.installment_count,
            'order_id': self. order_id. name if self.order_id else self.transaction_id,
            'success_url': self._get_callback_url('success'),
            'fail_url': self._get_callback_url('fail'),
            'bank_config': config,
        }
        
        self.request_data = json. dumps(payload, indent=2)
        return payload
    
    def _get_callback_url(self, status):
        """Callback URL oluştur"""
        base_url = self. env['ir.config_parameter'].sudo().get_param('web. base. url')
        return f"{base_url}/mews_pos/callback/{status}/{self.transaction_id}"
    
    def _process_cancel(self):
        """İptal işlemi"""
        self.write({
            'state':  'cancelled',
            'processed_at': fields. Datetime.now(),
        })
        return True
    
    def _process_refund(self):
        """İade işlemi"""
        self.write({
            'state': 'refunded',
            'processed_at':  fields.Datetime. now(),
        })
        return True